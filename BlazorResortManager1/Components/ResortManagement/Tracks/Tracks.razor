@page "/resort/Track"
@attribute [Authorize]
@inject IStringLocalizer<AppLanguage> local

<h3 class="text-3xl font-bold">@local["Tracks"]</h3>

@if (resortData is not null)
{
    <RadzenStack>
        <RadzenRow>
            <RadzenColumn>
                <RadzenStack JustifyContent="JustifyContent.Right" Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Style="width: 10%" Text="@local["Add new"]" Click="@(() => navigationManager.NavigateTo("/resort/track/add"))" />
                    <RadzenButton Style="width: 10%" Text="@local["Edit"]" Click="editTrack" Icon="Edit_Note" Variant="Variant.Outlined" Disabled="@(selectedTracks?.Any() == true ? false : true)" />
                    <RadzenButton Style="width: 10%" Text="@local["Delete"]" Click="deleteTrack" Icon="Delete" Variant="Variant.Outlined" Disabled="@(selectedTracks?.Any() == true ? false : true)" ButtonStyle="ButtonStyle.Danger" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow>
            <RadzenColumn>
                <RadzenDataGrid TItem="Track" Data=@resortData.tracks CellEditMode="Cell" AllowAlternatingRows="false" AllowFiltering="false" AllowPaging="false" AllowSorting="true"
                                @bind-Value=selectedTracks SelectionMode="DataGridSelectionMode.Single">
                    <Columns>
                        <RadzenDataGridColumn TItem="Track" Property="id" Title="@local["ID"]" Width="100px" Frozen="true" />

                        <RadzenDataGridColumn TItem="Track" Property="name" Title="@local["Name"]" Width="100px" />

                        <RadzenDataGridColumn TItem="Track" Property="marking" Title="@local["Marking"]" Width="100px" />

                        <RadzenDataGridColumn TItem="Track" Property="difficulty" Title="@local["Difficulty"]" Width="100px" />

                        <RadzenDataGridColumn TItem="Track" Property="inclination" Title="@local["Inclination"]" Width="100px" TextAlign="TextAlign.Center"/>

                        <RadzenDataGridColumn TItem="Track" Title="@local["Snow groomed"]" Width="100px" TextAlign="TextAlign.Center">
                            <Template Context="track">
                                <RadzenIcon Icon="@(track.snowGroomed ? "Check_Circle" : "Cancel")" IconColor="@(track.snowGroomed ? Colors.Success : Colors.Danger)" />
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Track" Title="@local["Illuminated"]" Width="100px" TextAlign="TextAlign.Center">
                            <Template Context="track">
                                <RadzenIcon Icon="@(track.illuminated ? "Check_Circle" : "Cancel")" IconColor="@(track.illuminated ? Colors.Success : Colors.Danger)" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
}
else
{
    <p>@local["Select resort first"]</p>
}

@inject IDbContextFactory<ApplicationDbContext> contextFactory
@inject DialogService dialogService
@inject NotificationService notificationService
@inject ContextMenuService contextMenuService
@inject NavigationManager navigationManager
@inject ResortChangeManager resortChangeManager
@implements IDisposable

@code {
    [CascadingParameter]
    public Resort? selectedResort { get; set; }

    private Resort resortData { get; set; }

    private IList<Track> selectedTracks { get; set; } = new List<Track>();

    protected override async Task OnInitializedAsync()
    {
        updateData();
        resortChangeManager.ResortChange += updateData;
    }

    private async Task deleteTrack()
    {
        var result = await dialogService.OpenAsync<_ConfirmDialog>(
            local["Confirm action"], new Dictionary<string, object>() { },
            new DialogOptions() { ShowClose = false });

        if (result == true)
        {
            bool error = false;
            try
            {
                var track = selectedTracks.FirstOrDefault();

                if (track != null)
                {
                    selectedTracks.Clear();

                    using (var database = contextFactory.CreateDbContext())
                    {
                        var cameraBindings = await database.cameraTrackBindings.Where(e => e.trackId == track.id).ToArrayAsync();
                        foreach (var bind in cameraBindings)
                        {
                            database.cameraTrackBindings.Remove(bind);
                        }

                        var statuses = await database.trackStatuses.Where(e => e.parentTrackId == track.id).ToArrayAsync();
                        foreach (var tstatus in statuses)
                        {
                            database.trackStatuses.Remove(tstatus);
                        }
                        database.Remove(track);

                        await database.SaveChangesAsync();
                    }
                }
                else
                {
                    throw new Exception();
                }
            }
            catch
            {
                dialogService.Close();
                error = true;
            }

            var notifMessage = new NotificationMessage
                {
                    Severity = !error ? NotificationSeverity.Success : NotificationSeverity.Error,
                    Summary = !error ? local["Deleted data successfully!"] : local["There was an error while executing the request"],
                    Duration = 3000
                };
            notificationService.Notify(notifMessage);
            updateData();
        }
    }

    private void editTrack()
    {
        if (selectedTracks?.Any() == true)
        {
            navigationManager.NavigateTo("/resort/track/edit/" + selectedTracks[0].id);
        }
    }

    private async void updateData(ResortChangeEventArgs? eventArgs = null)
    {
        if (selectedResort is not null)
        {
            using (var database = contextFactory.CreateDbContext())
            {
                resortData = selectedResort;
                resortData.tracks = await database.tracks.Where(e => e.resortId == selectedResort.id).ToListAsync();
            }
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        resortChangeManager.ResortChange -= updateData;
    }
}
